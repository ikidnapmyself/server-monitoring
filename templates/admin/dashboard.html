{% extends "admin/index.html" %}
{% load i18n %}

{% block content %}
<div id="dashboard" style="margin-bottom: 30px;">

  <!-- Row 1: Active Incidents + Pipeline Health -->
  <div style="display: flex; gap: 20px; margin-bottom: 20px;">

    <!-- Active Incidents -->
    <div class="module" style="flex: 1; padding: 15px;">
      <h2 style="margin-top: 0;">Active Incidents</h2>
      {% if active_incidents.total > 0 %}
      <div style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">
        {{ active_incidents.total }}
      </div>
      <div style="display: flex; gap: 10px;">
        {% if active_incidents.critical > 0 %}
        <span style="background:#dc3545;color:#fff;padding:3px 8px;border-radius:3px;font-size:12px;">
          {{ active_incidents.critical }} Critical
        </span>
        {% endif %}
        {% if active_incidents.warning > 0 %}
        <span style="background:#ffc107;color:#000;padding:3px 8px;border-radius:3px;font-size:12px;">
          {{ active_incidents.warning }} Warning
        </span>
        {% endif %}
        {% if active_incidents.info > 0 %}
        <span style="background:#17a2b8;color:#fff;padding:3px 8px;border-radius:3px;font-size:12px;">
          {{ active_incidents.info }} Info
        </span>
        {% endif %}
      </div>
      <div style="margin-top: 10px;">
        <a href="/admin/alerts/incident/?status__exact=open">View all &rarr;</a>
      </div>
      {% else %}
      <div style="color: #28a745; font-size: 18px;">No active incidents</div>
      {% endif %}
    </div>

    <!-- Pipeline Health (24h) -->
    <div class="module" style="flex: 1; padding: 15px;">
      <h2 style="margin-top: 0;">Pipeline Health (24h)</h2>
      {% if pipeline_health.total > 0 %}
      <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">
        {{ pipeline_health.success_rate }}%
      </div>
      <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
        {{ pipeline_health.successful }}/{{ pipeline_health.total }} runs succeeded
      </div>
      <div style="background:#eee;border-radius:4px;height:8px;margin-bottom:10px;">
        <div style="background:{% if pipeline_health.success_rate >= 90 %}#28a745{% elif pipeline_health.success_rate >= 70 %}#ffc107{% else %}#dc3545{% endif %};
                    height:8px;border-radius:4px;width:{{ pipeline_health.success_rate }}%;"></div>
      </div>
      <div style="display:flex;gap:15px;font-size:12px;">
        <span>Failed: <strong>{{ pipeline_health.failed }}</strong></span>
        <span>Retrying: <strong>{{ pipeline_health.retrying }}</strong></span>
        <span>In-flight: <strong>{{ pipeline_health.in_flight }}</strong></span>
      </div>
      {% else %}
      <div style="color: #666;">No pipeline runs in the last 24 hours</div>
      {% endif %}
    </div>
  </div>

  <!-- Row 2: Recent Check Runs + Failed Pipelines -->
  <div style="display: flex; gap: 20px; margin-bottom: 20px;">

    <div class="module" style="flex: 1; padding: 15px;">
      <h2 style="margin-top: 0;">Recent Check Runs</h2>
      {% if recent_check_runs %}
      <table style="width:100%;font-size:13px;">
        <thead>
          <tr>
            <th style="text-align:left;padding:4px 8px;">Checker</th>
            <th style="text-align:left;padding:4px 8px;">Host</th>
            <th style="text-align:left;padding:4px 8px;">Status</th>
            <th style="text-align:left;padding:4px 8px;">Time</th>
          </tr>
        </thead>
        <tbody>
          {% for run in recent_check_runs %}
          <tr>
            <td style="padding:4px 8px;">{{ run.checker_name }}</td>
            <td style="padding:4px 8px;">{{ run.hostname }}</td>
            <td style="padding:4px 8px;">
              <span style="background:{% if run.status == 'ok' %}#28a745{% elif run.status == 'warning' %}#ffc107{% elif run.status == 'critical' %}#dc3545{% else %}#6c757d{% endif %};
                          color:{% if run.status == 'warning' %}#000{% else %}#fff{% endif %};
                          padding:2px 6px;border-radius:3px;font-size:11px;">
                {{ run.status|upper }}
              </span>
            </td>
            <td style="padding:4px 8px;">{{ run.executed_at|timesince }} ago</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div style="margin-top:8px;"><a href="/admin/checkers/checkrun/">View all &rarr;</a></div>
      {% else %}
      <div style="color: #666;">No check runs recorded</div>
      {% endif %}
    </div>

    <div class="module" style="flex: 1; padding: 15px;">
      <h2 style="margin-top: 0;">Failed Pipelines</h2>
      {% if failed_pipelines %}
      <table style="width:100%;font-size:13px;">
        <thead>
          <tr>
            <th style="text-align:left;padding:4px 8px;">Run ID</th>
            <th style="text-align:left;padding:4px 8px;">Error</th>
            <th style="text-align:left;padding:4px 8px;">When</th>
          </tr>
        </thead>
        <tbody>
          {% for run in failed_pipelines %}
          <tr>
            <td style="padding:4px 8px;">
              <a href="/admin/orchestration/pipelinerun/{{ run.pk }}/change/">{{ run.run_id|truncatechars:12 }}</a>
            </td>
            <td style="padding:4px 8px;">{{ run.last_error_type|default:"Unknown"|truncatechars:40 }}</td>
            <td style="padding:4px 8px;">{{ run.created_at|timesince }} ago</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div style="margin-top:8px;">
        <a href="/admin/orchestration/pipelinerun/?status__exact=failed">View all &rarr;</a>
      </div>
      {% else %}
      <div style="color: #28a745;">No failed pipelines</div>
      {% endif %}
    </div>
  </div>

  <!-- Row 3: 7-Day Trends -->
  <div class="module" style="padding: 15px; margin-bottom: 20px;">
    <h2 style="margin-top: 0;">7-Day Trends</h2>
    <div style="display: flex; gap: 20px;">

      <div style="flex: 1;">
        <h3 style="font-size: 14px; margin-bottom: 8px;">Top Failing Checkers</h3>
        {% if top_failing_checkers %}
        <table style="width:100%;font-size:13px;">
          {% for item in top_failing_checkers %}
          <tr>
            <td style="padding:3px 0;">{{ item.checker_name }}</td>
            <td style="padding:3px 0;text-align:right;font-weight:bold;">{{ item.count }}</td>
          </tr>
          {% endfor %}
        </table>
        {% else %}
        <div style="color:#666;font-size:13px;">No failures</div>
        {% endif %}
      </div>

      <div style="flex: 1;">
        <h3 style="font-size: 14px; margin-bottom: 8px;">Top Error Types</h3>
        {% if top_error_types %}
        <table style="width:100%;font-size:13px;">
          {% for item in top_error_types %}
          <tr>
            <td style="padding:3px 0;">{{ item.last_error_type|default:"Unknown" }}</td>
            <td style="padding:3px 0;text-align:right;font-weight:bold;">{{ item.count }}</td>
          </tr>
          {% endfor %}
        </table>
        {% else %}
        <div style="color:#666;font-size:13px;">No errors</div>
        {% endif %}
      </div>

      <div style="flex: 1;">
        <h3 style="font-size: 14px; margin-bottom: 8px;">AI Provider Usage</h3>
        {% if provider_usage %}
        <table style="width:100%;font-size:13px;">
          <thead>
            <tr>
              <th style="text-align:left;">Provider</th>
              <th style="text-align:right;">Runs</th>
              <th style="text-align:right;">Tokens</th>
            </tr>
          </thead>
          {% for item in provider_usage %}
          <tr>
            <td style="padding:3px 0;">{{ item.provider }}</td>
            <td style="padding:3px 0;text-align:right;">{{ item.runs }}</td>
            <td style="padding:3px 0;text-align:right;">{{ item.tokens|default:0 }}</td>
          </tr>
          {% endfor %}
        </table>
        {% else %}
        <div style="color:#666;font-size:13px;">No analysis runs</div>
        {% endif %}
      </div>
    </div>
  </div>

</div>

{{ block.super }}
{% endblock %}