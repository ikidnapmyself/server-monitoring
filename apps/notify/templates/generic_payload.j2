{%- set has_recs = recommendations and recommendations[0] is mapping and recommendations[0].title is defined -%}
{
  "title": {{ title | tojson }},
  "message": {{ message | tojson }},
  "severity": "{{ severity }}",
  "channel": {{ channel | tojson }},
  "tags": {{ tags | tojson }},
  "context": {{ context | tojson }},
  "incident_id": {{ incident_id | tojson }}{% if intelligence and intelligence.summary %},
  "summary": {{ intelligence.summary | tojson }}{% endif %}{% if has_recs %},
  "recommendations": [
    {% for r in recommendations %}{"title": {{ (r.title | default('')) | tojson }}, "description": {{ (r.description | default('')) | tojson }}}{% if not loop.last %},
    {% endif %}{% endfor %}
  ]{% endif %}
}
