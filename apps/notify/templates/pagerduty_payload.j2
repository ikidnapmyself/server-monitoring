{%- set has_recs = recommendations and recommendations[0] is mapping and recommendations[0].title is defined -%}
{
  "summary": "[{{ severity | upper }}] {{ title }}",
  "severity": "{{ severity }}",
  "source": {{ (incident.source or tags.source or 'server-maintenance') | tojson }},
  "component": {{ (tags.component or channel) | tojson }},
  "group": {{ (tags.group or 'default') | tojson }},
  "class": {{ (tags.class or severity) | tojson }},
  "custom_details": {
    "message": {{ message | tojson }},
    "severity": "{{ severity }}",
    "cpu_count": {{ incident.cpu_count | tojson }},
    "ram_total_human": {{ incident.ram_total_human | tojson }},
    "disk_total_human": {{ incident.disk_total_human | tojson }}{% if tags %},
    {% for key, value in tags.items() %}"{{ key }}": {{ value | tojson }}{% if not loop.last %},
    {% endif %}{% endfor %}{% endif %}{% if context %},
    {% for key, value in context.items() %}"{{ key }}": {{ value | tojson }}{% if not loop.last %},
    {% endif %}{% endfor %}{% endif %}{% if has_recs %},
    "recommendations": [
      {% for r in recommendations %}{"title": {{ (r.title | default('')) | tojson }}, "description": {{ (r.description | default('')) | tojson }}}{% if not loop.last %},
      {% endif %}{% endfor %}
    ]{% endif %}
  }
}
